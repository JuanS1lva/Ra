

# üìò Especificaci√≥n T√©cnica ‚Äì APPBASE

## 1. Visi√≥n general

**APPBASE** es una aplicaci√≥n modular tipo intranet orientada a **pymes**, dise√±ada para centralizar la gesti√≥n administrativa (TI, documentos, tickets, etc.) y escalar mediante m√≥dulos especializados seg√∫n el enfoque de cada empresa.

La plataforma est√° dise√±ada como un **monolito modular**, preparada para evolucionar sin refactorizaciones dr√°sticas hacia escenarios m√°s complejos (corporaciones, microservicios, integraciones externas).

---

## 2. Objetivos t√©cnicos

- Arquitectura monolito modular (no microservicios prematuros)
- Multi-tenant desde el d√≠a 1
- Backend desacoplado, tipado y testeable
- Frontend SPA moderno y extensible
- Entorno 100% Docker para desarrollo
- Escalabilidad futura sin redise√±o estructural
- Base s√≥lida para automatizaciones y m√≥dulos vendibles

---

## 3. Stack tecnol√≥gico

### Backend
- Node.js **20.x (LTS)**
- NestJS
- Prisma ORM
- PostgreSQL
- Redis (colas / jobs)
- pnpm (monorepo workspaces)

### Frontend
- Vue 3
- Vite
- Pinia
- Vue Router

### Infraestructura
- Docker
- Docker Compose
- Nginx (reverse proxy)
- Preparado para AWS (ECS / EC2 / RDS / S3)

---

## 4. Arquitectura general

### 4.1 Tipo de arquitectura
- Monolito modular
- Separaci√≥n clara por dominios
- Cada m√≥dulo es:
  - independiente
  - activable por tenant
  - protegido por permisos

### 4.2 Multi-tenancy
- Todas las entidades persistentes incluyen `tenantId`
- El `tenantId` proviene del contexto autenticado
- No existen datos globales sin contexto

> Dise√±o futuro:
> - `tenant` = corporaci√≥n
> - `org` = empresa/unidad (no implementado a√∫n)

---

## 5. Monorepo ‚Äì Estructura

```txt
apps/
  api/        # Backend NestJS
  web/        # Frontend Vue 3
packages/
  shared/     # Tipos y contratos compartidos
infra/
  nginx/      # Reverse proxy
docs/
  DocumentacionTecnica.MD
```

---

## 6. Backend ‚Äì NestJS

### 6.1 Organizaci√≥n por capas

Cada m√≥dulo sigue estrictamente:

```
Controller ‚Üí Service ‚Üí Repository ‚Üí Prisma
```

- **Controller**: HTTP, DTOs, Guards
- **Service**: l√≥gica de negocio
- **Repository**: queries Prisma
- **Prisma**: acceso a base de datos

No se mezcla l√≥gica HTTP con l√≥gica de negocio.

---

### 6.2 M√≥dulos Core

#### 6.2.1 Tenants
Gesti√≥n de empresas (pymes).

Endpoints:
- `POST /tenants`
- `GET /tenants/me`
- `PATCH /tenants/me`

---

#### 6.2.2 Users
Usuarios dentro de un tenant.

Endpoints:
- `POST /users`
- `GET /users`
- `PATCH /users/:id`

Reglas:
- Email √∫nico por tenant
- Usuarios pueden deshabilitarse

---

#### 6.2.3 RBAC (Roles & Permissions)
Control de acceso basado en roles.

- Permisos con formato:
  ```
  <module>.<action>
  ```
- Ejemplos:
  - `tickets.read`
  - `docs.write`
  - `it.manage`

Entidades:
- Role
- Permission
- UserRole
- RolePermission

---

#### 6.2.4 Modules Registry
Sistema que permite activar/desactivar m√≥dulos por tenant.

- Cat√°logo definido en c√≥digo
- Persistencia en `module_subscriptions`
- Guard que bloquea endpoints si el m√≥dulo no est√° activo

---

#### 6.2.5 Audit
Auditor√≠a autom√°tica de acciones relevantes.

Registra:
- usuario
- acci√≥n
- entidad
- timestamp
- correlationId

---

#### 6.2.6 Files
Gesti√≥n de archivos y adjuntos.

- Local storage en desarrollo
- Preparado para S3 en producci√≥n
- Descargas seguras

---

#### 6.2.7 Notifications
Notificaciones internas (in-app).

Eventos:
- ticket asignado
- ticket actualizado
- vencimientos

---

#### 6.2.8 Auth
Autenticaci√≥n desacoplada.

Inicial:
- Headers de desarrollo:
  - `x-tenant-id`
  - `x-user-id`

Futuro:
- Google OAuth
- Usuario/contrase√±a
- Auth0 u otro proveedor externo

---

## 7. M√≥dulos Feature (vendibles)

### 7.1 Tickets
Primer m√≥dulo funcional del producto.

Funcionalidad:
- creaci√≥n y edici√≥n de tickets
- asignaci√≥n
- estados
- prioridades
- comentarios
- historial de cambios

Permisos:
- `tickets.read`
- `tickets.write`
- `tickets.assign`
- `tickets.comment`
- `tickets.manage`

---

### 7.2 Docs
Gesti√≥n documental.

Funcionalidad:
- carpetas
- documentos
- versionado simple
- permisos por rol

---

### 7.3 IT Assets
Inventario de activos TI.

Funcionalidad:
- activos
- asignaciones
- historial
- alertas de vencimiento

---

## 8. Request Context

Cada request tiene un contexto com√∫n:

- `tenantId`
- `userId`
- `correlationId`

Implementaci√≥n:
- Middleware con `AsyncLocalStorage`
- Decoradores:
  - `@TenantId()`
  - `@UserId()`

---

## 9. Guards y seguridad

Guards est√°ndar:
- TenantGuard
- PermissionsGuard
- ModuleEnabledGuard

Decoradores:
- `@RequirePermissions([...])`
- `@Module('tickets')`

---

## 10. Base de datos (Prisma)

### 10.1 Reglas generales
- Todas las tablas incluyen `tenantId` cuando aplica
- √çndices compuestos `(tenantId, campo)`
- No existen claves √∫nicas globales sin `tenantId`

### 10.2 Tablas base (MVP)
- tenants
- users
- roles
- permissions
- module_subscriptions
- audit_logs
- files
- notifications
- tickets
- ticket_comments
- ticket_status_history

---

## 11. Frontend ‚Äì Vue 3

### 11.1 Enfoque
- SPA
- Router din√°mico seg√∫n m√≥dulos y permisos
- Layout √∫nico con sidebar

---

### 11.2 Estructura

```txt
src/
  api/        # llamadas HTTP por dominio
  store/      # Pinia stores
  router/     # rutas y guards
  layouts/    # AppShell, AuthLayout
  pages/      # vistas por m√≥dulo
```

---

### 11.3 Stores clave
- auth
- tenant
- modules
- rbac

---

## 12. Flujo de desarrollo recomendado

1. Backend Core
2. Backend Tickets completo
3. Frontend infraestructura base
4. Tickets UI
5. Docs / IT Assets
6. Autenticaci√≥n real
7. Automatizaciones y reportes

---

## 13. Uso de IA (Antigravity, Codex, etc.)

Las tareas deben pedirse de forma **at√≥mica**, por ejemplo:

- Crear m√≥dulo `TicketsModule` con controller/service/repository
- Dise√±ar schema Prisma para tickets
- Crear guard de permisos
- Crear `TicketsList.vue` consumiendo API existente

Codex **no debe inventar contratos**:  
los endpoints y DTOs deben seguir esta especificaci√≥n.

---

## 14. Preparaci√≥n para AWS (futuro)

- API: contenedor Docker
- DB: RDS PostgreSQL
- Files: S3
- Frontend: build est√°tico + CDN
- Secrets: AWS Secrets Manager

No se requieren cambios estructurales.

---

## 15. Estado del documento

- Documento vivo
- Referencia principal del proyecto
- Se actualiza al agregar m√≥dulos o cambiar arquitectura

---

**Fin de la especificaci√≥n t√©cnica**